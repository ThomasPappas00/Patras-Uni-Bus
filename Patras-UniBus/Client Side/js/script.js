const ip = "localhost";
let select = document.getElementById("selectLine");

function myMapFirst() {
    let lineSelect = localStorage.getItem("line");
    select.value = (lineSelect == 'line2' ? 'line2' : 'line1');
    myMap();
}

function myMap() {
    let mapProp = {
        center: new google.maps.LatLng(38.28977569915819, 21.79122152719676),
        zoom: 15,
        clickableIcons: false
    };
    let map = new google.maps.Map(document.getElementById("googleMap"), mapProp);
    populateMap(map);
}

function populateMap(map) {
    let line;
    let id;
    let option = select.value;
    localStorage.setItem("line", select.value);
    select.addEventListener("change", function() {
        localStorage.setItem("line", select.value);
    })
    if (option == "line1") {
        line = line1;
        id = '1';
    }
    else {
        line = line2;
        id = '2';
    }
    updateInfo(map, id);
    createLine(map, line);
}

function updateInfo(map, id) {
    createStops(map, id);
    createBuses(map, id);
}

function createStops(map, id) {
    const myIcon = {
        url: 'images/bus-stop.png',
        scaledSize: new google.maps.Size(25, 25),
        anchor: new google.maps.Point(12, 12)
    }
    let stops = [];
    let windows = [];
    fetch("http://" + ip + ":8080//CampusBuses/busstops/line?line=" + id).then(
        (response) => response.json().then(
            (StopsJson) => {
                console.log(StopsJson);
                for (let i = 0; i < StopsJson.length; i++) {
                    let stop = StopsJson[i];
                    let location = stop.location.split(",");
                    const myCenter = new google.maps.LatLng(location[0], location[1]);
                    let marker = new google.maps.Marker({
                        position: myCenter,
                        icon: myIcon,
                        map: map
                    });
                    stops.push(marker);
                    let content = '<div id="content">' +
                        '<h6> Στάση:&nbsp;&nbsp;&nbsp;' + stop.name + '</h6>';
                    if (id == 2){
                        content += '<h6> Περιμένουν:&nbsp;&nbsp;&nbsp;' + stop.pplWaiting + '</h6>';
                    }
                    content += '</div>';
                    let infowindow = new google.maps.InfoWindow({
                        content: content
                    });
                    marker.addListener("click", () => {
                        for (let i=0; i<windows.length; i++){
                            windows[i].close();
                        }
                        infowindow.open(map, marker);
                    });
                    windows.push(infowindow);
                }
            })
    )
    let update = setInterval(function () { updateStops(map, stops, windows, id) }, 4000);
    select.addEventListener("change", function(){
        clearInterval(update);
    });
}

function updateStops(map, stops, windows, id) {
    fetch("http://" + ip + ":8080//CampusBuses/busstops/line?line=" + id).then(
        (response) => response.json().then(
            (StopsJson) => {
                console.log(StopsJson);
                for (let i = 0; i < StopsJson.length; i++) {
                    let stop = StopsJson[i];
                    let content = '<div id="content">' +
                        '<h6> Στάση:&nbsp;&nbsp;&nbsp;' + stop.name + '</h6>';
                    if (id == 2){
                        content += '<h6> Περιμένουν:&nbsp;&nbsp;&nbsp;' + stop.pplWaiting + '</h6>';
                    }
                    content += '</div>';
                    windows[i].setContent(content);
                }
            })
    )
}

function createBuses(map, id) {
    const myIcon = {
        url: 'images/bus.png',
        scaledSize: new google.maps.Size(50, 50),
        labelOrigin: new google.maps.Point(25, -8)
    }
    let buses = [];
    let windows = [];
    fetch("http://" + ip + ":8080//CampusBuses/buses/line?line=" + id).then(
        (response) => response.json().then(
            (BusesJson) => {
                console.log(BusesJson);
                for (let i = 0; i < BusesJson.length; i++) {
                    let bus = BusesJson[i];
                    if (bus.location) {
                        let location = bus.location.split(",");
                    }
                    else {
                        let location = ['0.0', '0.0'];
                    }
                    const myCenter = new google.maps.LatLng(location[0], location[1]);
                    let marker = new google.maps.Marker({
                        position: myCenter,
                        icon: myIcon,
                        label: bus.id.toString(),
                        map: map
                    });
                    if (!bus.location) {
                        marker.setMap(null);
                    }
                    buses.push(marker);
                    let content = '<div id="content">' +
                        '<h6> Λεωφορείο&nbsp;&nbsp;' + bus.id + '</h6>' +
                        '<h6> Επιβάτες:&nbsp;&nbsp;&nbsp;' + bus.passengers + '</h6>' +
                        '<h6> Επόμενη Στάση:&nbsp;&nbsp; ' + bus.nextStop + '</h6>';
                    if (bus.highTemp > 0){
                        content += '<h6> Βρέθηκαν &nbsp; ' + bus.highTemp + ' επιβάτες με πυρετό</h6>';
                    }
                    content += '</div>';
                    let infowindow = new google.maps.InfoWindow({
                        content: content
                    });
                    marker.addListener("click", () => {
                        for (let i=0; i<windows.length; i++){
                            windows[i].close();
                        }
                        infowindow.open(map, marker);
                    });
                    windows.push(infowindow);
                }
                let update = setInterval(function () { updateBuses(map, buses, windows, id) }, 2000);
                select.addEventListener("change", function(){
                    clearInterval(update);
                    myMap();
                });
            })

    )
}

function updateBuses(map, buses, windows, id) {
    fetch("http://" + ip + ":8080//CampusBuses/buses/line?line=" + id).then(
        (response) => response.json().then(
            (BusesJson) => {
                console.log(BusesJson);
                for (let i = 0; i < BusesJson.length; i++) {
                    let bus = BusesJson[i];
                    if (bus.location) {
                        let location = bus.location.split(",");
                        const myCenter = new google.maps.LatLng(location[0], location[1]);
                        buses[i].setPosition(myCenter);
                        buses[i].setMap(map);
                    }
                    else {
                        buses[i].setMap(null);
                    }
                    let content = '<div id="content">' +
                        '<h6> Λεωφορείο&nbsp;&nbsp;' + bus.id + '</h6>' +
                        '<h6> Επιβάτες:&nbsp;&nbsp;&nbsp;' + bus.passengers + '</h6>' +
                        '<h6> Επόμενη Στάση:&nbsp;&nbsp; ' + bus.nextStop + '</h6>';
                    if (bus.highTemp > 0){
                        content += '<h6> Βρέθηκαν &nbsp; ' + bus.highTemp + ' επιβάτες με πυρετό</h6>';
                    }
                    content += '</div>';
                    windows[i].setContent(content);
                }
            })

    )
}

function createLine(map, line) {
    var myTrip = [];
    for (let i = 0; i < line.length - 2; i += 2) {
        myTrip.push(new google.maps.LatLng(line[i], line[i + 1]))
    }
    var flightPath = new google.maps.Polyline({
        path: myTrip,
        strokeColor: line[line.length - 1],
        strokeOpacity: 0.6,
        strokeWeight: 8,
        map: map
    });
}

const line1 = [
    38.28466087281371, 21.78339697371026,
    38.28482719757902, 21.783498897643756,
    38.28493036084954, 21.78362496145624,
    38.28509879036388, 21.783860995828555,
    38.28524406050609, 21.784134581123737,
    38.28539354107355, 21.784394755375033,
    38.28547564998669, 21.784550323484055,
    38.28553881063329, 21.784665658513216,
    38.2856061819212, 21.784861459753884,
    38.285696711990845, 21.785046532159445,
    38.28576829382646, 21.785169913763156,
    38.28581250610761, 21.785274519971544,
    38.28589461454681, 21.785478367838536,
    38.28597882823411, 21.785593702815916,
    38.28604619911361, 21.785725131045954,
    38.28608198986791, 21.78578413963903,
    38.28615146599363, 21.785907521279007,
    38.2862272580484, 21.786073818223134,
    38.286258838047885, 21.786138191233764,
    38.28635778862388, 21.786277666090132,
    38.28643989644954, 21.786452009705457,
    38.286528320154375, 21.786637082111014,
    38.28659358520076, 21.786747052670844,
    38.286654639545866, 21.78687043427455,
    38.28673674704009, 21.786988451516784,
    38.28682306506684, 21.787184252757456,
    38.28688201390418, 21.787275447855844,
    38.28693464675419, 21.78738005399812,
    38.28696201582113, 21.78739882945956,
    38.28705886012893, 21.78731836319627,
    38.2871346512362, 21.787235214724202,
    38.28718728390304, 21.787205710427664,
    38.287271496102136, 21.787127926360032,
    38.28738097179986, 21.787031366844086,
    38.28743781488549, 21.786977722668567,
    38.287507289707435, 21.786934807328144,
    38.28759360681786, 21.78685970548241,
    38.28769676615663, 21.78676582817524,
    38.28779571478551, 21.786706819569996,
    38.287900979122256, 21.786602213427724,
    38.28799150632975, 21.78651101832933,
    38.288094665102996, 21.786443963109917,
    38.28818940262273, 21.786355450220306,
    38.28823782398069, 21.786312534858883,
    38.288322034949324, 21.78625084405703,
    38.288420982712644, 21.78616233116741,
    38.2885178250738, 21.786073818277796,
    38.288629404155735, 21.785993352014504,
    38.288738877812996, 21.785891428059287,
    38.28882308820028, 21.78582705504866,
    38.28892414054678, 21.78573049549906,
    38.28911571854717, 21.785542740884722,
    38.28918729701096, 21.78548105008287,
    38.289267296386924, 21.78539253719325,
    38.289359927133155, 21.785338893017727,
    38.28945255776116, 21.78523428687545,
    38.28951360970133, 21.78519137153503,
    38.28957887207346, 21.785121634069622,
    38.28974097510586, 21.784979477004477,
    38.28978939542191, 21.784968748169373,
    38.289869394134236, 21.784909739576296,
    38.28987570981828, 21.784880235279758,
    38.28995991888701, 21.784799769016942,
    38.29005675919472, 21.78473003158876,
    38.29009044274971, 21.784692480665896,
    38.29016833591076, 21.784628107655266,
    38.29023359768403, 21.78457982789729,
    38.290275702035444, 21.784555688001607,
    38.29034938456941, 21.78457178125426,
    38.29043569829974, 21.784671022978984,
    38.29050306504236, 21.784778311330037,
    38.29057253693018, 21.784923150603955,
    38.29063148272223, 21.785008981284793,
    38.29073463774316, 21.78519137148158,
    38.290831477017086, 21.78537644388714,
    38.2908925277973, 21.78550250769963,
    38.290953578537895, 21.785577609605983,
    38.29105883829462, 21.78575999980277,
    38.29110936292362, 21.78585924152749,
    38.29114936156329, 21.785931661164454,
    38.29116199270808, 21.785966529878547,
    38.29121462245437, 21.786046996141835,
    38.29129882996908, 21.786178424371872,
    38.29135777517121, 21.78632058143701,
    38.29145461361363, 21.786497607216244,
    38.29149250689017, 21.786567344714108,
    38.29155776747269, 21.786714866196803,
    38.291639869412485, 21.786798014668868,
    38.291726181608034, 21.78696699382177,
    38.291751443694615, 21.78702868462363,
    38.291818809222015, 21.78713865522094,
    38.29186301781133, 21.78722448590178,
    38.29188827985028, 21.7872781300773,
    38.29197248658331, 21.787393465054684,
    38.292069324205485, 21.787589266295353,
    38.2921072171529, 21.787667050349864,
    38.29218300298837, 21.787774338700917,
    38.29220405460503, 21.787854805037938,
    38.29235352083855, 21.788082792783918,
    38.29241878064677, 21.788187398926194,
    38.29246719917623, 21.78832150936501,
    38.29251982797599, 21.788428797716062,
    38.292557720688166, 21.78847707747403,
    38.29267771415427, 21.78866751435228,
    38.29282717941221, 21.788962557317667,
    38.292902964495816, 21.7890832567126,
    38.29295559298787, 21.789177134076805,
    38.29311558334395, 21.78945340158076,
    38.29317452707045, 21.78956605434937,
    38.29319978865771, 21.789700164862868,
    38.293260837445565, 21.789826228675352,
    38.29337872461469, 21.78991474156497,
    38.29345661424637, 21.790067627465213,
    38.29349240134641, 21.790145411519728,
    38.29357239597678, 21.79027147533221,
    38.2936313393322, 21.79037339926571,
    38.293723964508295, 21.7905101919133,
    38.29375764636121, 21.790601387011694,
    38.29387553273605, 21.79076500183605,
    38.2940123648804, 21.791011765043468,
    38.29409025383195, 21.791178061987598,
    38.29417445800982, 21.791336312305397,
    38.29425234678741, 21.791491880414423,
    38.294336550777196, 21.79159380434792,
    38.294368127256135, 21.791663541821674,
    38.29448601262641, 21.791862025271122,
    38.29455337560913, 21.79202027558892,
    38.294662840333814, 21.792167797153702,
    38.294820721841425, 21.792468204536643,
    38.29490913533559, 21.792586221722797,
    38.29499544364269, 21.792755200875703,
    38.29513227367523, 21.792985870830464,
    38.295222791870636, 21.793119981311744,
    38.29544803431205, 21.793471350661434,
    38.29554486730154, 21.793661787534436,
    38.295681696298026, 21.793844177731224,
    38.29579536942199, 21.794061436642096,
    38.295881676680956, 21.794176771674604,
    38.29597850908646, 21.794337704201176,
    38.2960900766978, 21.79451741218919,
    38.2961721735098, 21.794622018331463,
    38.29622269458812, 21.794713213480687,
    38.2963595223064, 21.794922425765233,
    38.29645635407885, 21.795096769382955,
    38.296534240407006, 21.795201375525227,
    "#F58A20"
];

const line2 = [
    38.29664965157011, 21.79507530008119,
    38.29661807609092, 21.795022997005628,
    38.29659281569851, 21.794976058352045,
    38.296569660331066, 21.794950577368674,
    38.29653282223131, 21.794906320923864,
    38.29649808914866, 21.794843289017617,
    38.29647493375099, 21.794807079199142,
    38.2964286229335, 21.794723930727077,
    38.29640862506836, 21.79469844971531,
    38.29634652640868, 21.794605913512523,
    38.2962760075273, 21.794477167491266,
    38.29622127640796, 21.794398042332368,
    38.29618338560883, 21.794352444783172,
    38.2961423372208, 21.794277342937434,
    38.29611181404539, 21.79422638097068,
    38.29610655142226, 21.79421028768569,
    38.29602655958554, 21.794097634917083,
    38.2959907737353, 21.79402387417574,
    38.29595919797043, 21.793989005461647,
    38.29591604440288, 21.79392731465979,
    38.295874995863606, 21.793852212814052,
    38.29582973719082, 21.79378381649026,
    38.29557607758009, 21.79329163109508,
    38.29536346594965, 21.793044867887662,
    38.295169799367834, 21.792647900988776,
    38.29500349830358, 21.792393091155027,
    38.29492350525084, 21.792275073968874,
    38.294797200251175, 21.792079272728206,
    38.29469826116953, 21.791926386737988,
    38.29460142705553, 21.791757407585088,
    38.294531959024575, 21.791617932728716,
    38.29437197179125, 21.79131216092822,
    38.29426250663098, 21.791172686006476,
    38.294064626898034, 21.7907971767778,
    38.293995158353184, 21.79062283320734,
    38.293883587513044, 21.790464582824633,
    38.29369202209878, 21.790118577892496,
    38.29361413271979, 21.790011289541447,
    38.29352992789168, 21.789861085849974,
    38.293475194701024, 21.789748433081368,
    38.29346256395887, 21.78955531404948,
    38.293350992307566, 21.7894855766213,
    38.293252051254534, 21.789343419440666,
    38.29320573838008, 21.789262953177374,
    38.29310258687168, 21.789064469727933,
    38.29299943521666, 21.78887671511359,
    38.29292575537329, 21.788750651301108,
    38.29284576003007, 21.788621905279843,
    38.292755238877454, 21.788455608335717,
    38.292711030831654, 21.788380506489982,
    38.29258051167054, 21.788139107608245,
    38.292426835596835, 21.787876251148173,
    38.29235526032813, 21.787723365247924,
    38.29225000245178, 21.787565114930125,
    38.292199478616915, 21.787428322282537,
    38.292098430841634, 21.787294211843722,
    38.292031065568864, 21.78715473690741,
    38.291923702053815, 21.786950889040412,
    38.29183107457986, 21.786776545469955,
    38.29174686768276, 21.78661561294338,
    38.29173634181376, 21.78645736262558,
    38.29159950537772, 21.7863876251974,
    38.29152371892383, 21.78623473921602,
    38.29141003910819, 21.786052349019233,
    38.2913531991336, 21.78592628520675,
    38.29125636054568, 21.78571975507632,
    38.29109215570543, 21.785486402912788,
    38.29104584145256, 21.78541398327583,
    38.29090689851182, 21.78516185560408,
    38.290738482475184, 21.784898999144,
    38.29065848472087, 21.78465491814536,
    38.29061427539776, 21.784625413848822,
    38.29055322438349, 21.78452080770655,
    38.29052585667075, 21.784327688674658,
    38.29043112219198, 21.784177484934986,
    38.290229021576195, 21.78426063340705,
    38.29019744330416, 21.784394743845862,
    38.29010060318418, 21.78450739661447,
    38.28989639640689, 21.78467637577907,
    38.28976587219521, 21.78480243959156,
    38.28954482259163, 21.785025062919985,
    38.28938692960548, 21.785151126732476,
    38.28921640478987, 21.785263779516118,
    38.289029037560354, 21.78546226296556,
    38.28892798537064, 21.785545411437624,
    38.28874482790752, 21.78570097958889,
    38.28854482786248, 21.78587532315935,
    38.28834693253864, 21.786057713356133,
    38.288161668332236, 21.786229374762428,
    38.287837454850546, 21.786497595640054,
    38.287635346999984, 21.78666657485166,
    38.287277446322335, 21.786953571190722,
    38.287113232473196, 21.787122550373446,
    38.28694901824891, 21.787240567609253,
    38.286900596037874, 21.78728348294967,
    38.28683954189968, 21.78716546576352,
    38.28673006538531, 21.78699112219306,
    38.28663532596076, 21.786803367578724,
    38.28654690238137, 21.78662902395028,
    38.28645426804495, 21.78645468037982,
    38.28639742418906, 21.786352756446323,
    38.28630900032477, 21.786199870546074,
    38.286260577686775, 21.78609794661257,
    38.286184785666784, 21.78596383617376,
    38.28611109890482, 21.785934331877222,
    38.286033201389415, 21.785993340470302,
    38.28600162127566, 21.78605771346877,
    38.285927934327745, 21.786095264391637,
    38.285871090059686, 21.78614890856716,
    38.2858416152365, 21.786173048446148,
    38.28577213882018, 21.78625083250066,
    38.28574476930458, 21.78624546808311,
    38.285650028593984, 21.78632861655517,
    38.28557213058376, 21.78640908281846,
    38.285481600358736, 21.786484184664193,
    38.285386859304666, 21.786556604301158,
    38.285285802044, 21.78663975277322,
    38.28520369291615, 21.78671217241018,
    38.285174217821954, 21.786747041124272,
    38.285127899792585, 21.78677654542081,
    38.285066844163275, 21.786814096343676,
    38.28503736901353, 21.78686237610165,
    38.28509421393449, 21.786975028870252,
    38.28513632125466, 21.787034037463332,
    38.28520579827956, 21.78717887673725,
    38.28526053770492, 21.787248614185245,
    38.28528790740312, 21.787326398239756,
    38.28537001643571, 21.787460508678567,
    38.28541633431106, 21.787543657172126,
    38.285456336088274, 21.787621441226637,
    38.28548581106792, 21.787683132028494,
    38.28550896997212, 21.787734093995244,
    38.28555949846468, 21.787750187247898,
    38.285635291137574, 21.78769922528115,
    38.28572371582258, 21.787640216688068,
    38.285816351091334, 21.787549021589676,
    38.28593214501106, 21.787471237535165,
    38.28601846399465, 21.787380042436773,
    38.286115309561396, 21.787296893964708,
    38.28622057633519, 21.78721106328387,
    38.28637005490076, 21.787082317247336,
    38.28643321476169, 21.78702330865426,
    38.28654690237287, 21.786921384720763,
    38.28663322062539, 21.786859693918906,
    38.28667743238799, 21.786907973718872,
    38.28672374942858, 21.78699648660849,
    38.28678269834656, 21.787082317289332,
    38.28682480468726, 21.78718424122283,
    38.28686270037299, 21.787243249815905,
    38.28691533323702, 21.787304940617762,
    38.28693428105872, 21.787369313628393,
    38.286976387311476, 21.787385406881047,
    38.28707954752749, 21.787286165156328,
    38.28719533943204, 21.78720569889304,
    38.2872332349243, 21.78717083017895,
    38.28735955309991, 21.787055495168637,
    38.28747534455776, 21.7869803933229,
    38.28765008404441, 21.786824825213873,
    38.287687979307314, 21.78677654544397,
    38.287807980817156, 21.786698761389456,
    38.28789008699905, 21.786604884082283,
    38.287999561763726, 21.786505642357564,
    38.288109036363295, 21.786435904929377,
    38.28815745777759, 21.78639567177315,
    38.28829430070356, 21.786253514708005,
    38.28842482756176, 21.78615695519206,
    38.28853430151988, 21.7860845355551,
    38.288624827937454, 21.78599065824793,
    38.28868377531147, 21.785950425116283,
    38.28877219628268, 21.785888734314433,
    38.2888837749853, 21.785773399297675,
    38.28903114280474, 21.785625877814976,
    38.28917219458022, 21.78550517842005,
    38.289359927133155, 21.785338893017727,
    38.28940694271122, 21.785284549126736,
    38.289454310630084, 21.785237610473157,
    38.28949325756243, 21.785203412311258,
    38.28952799399799, 21.785169884701556,
    38.28956325672614, 21.785137027644044,
    38.28960483514732, 21.78511355830944,
    38.28964115045552, 21.785071984073408,
    38.2896758868221, 21.785053879157775,
    38.28973693857442, 21.784992188355922,
    38.28979167458728, 21.784950614114464,
    38.28988114682384, 21.784875512254946,
    38.28993535641968, 21.784833267465164,
    38.29001798650254, 21.78476487113833,
    38.29006272249643, 21.78473000241976,
    38.2901411419935, 21.784654230016997,
    38.29022377184042, 21.784569740440546,
    38.29026482358103, 21.784537553924007,
    38.29039008386303, 21.78457644595126,
    38.29047850275546, 21.784504026314302,
    38.2905374486239, 21.78433907047456,
    38.29047534493814, 21.78422239436952,
    38.29034376915971, 21.784141928098606,
    38.290307980506924, 21.784053415208987,
    38.29023745575502, 21.783948809051676,
    38.29019114095506, 21.783876389390734,
    38.29012798436425, 21.783770442144068,
    "#03c2fc"
];